<%- include('./partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/stock">Stock</a></li>
        <li class="breadcrumb-item"><a href="/stock#<%= folder %>"><%= folder.charAt(0).toUpperCase() + folder.slice(1) %></a></li>
        <li class="breadcrumb-item active" aria-current="page"><%= file %></li>
      </ol>
    </nav>
    <h1><%= file %></h1>
  </div>
  <div>
    <span class="badge bg-primary">Total Accounts: <%= accountCount %></span>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Account List</h5>
        <div>
          <!-- Delete File Button -->
          <button type="button" class="btn btn-sm btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteFileModal">
            <i class="bi bi-trash"></i> Delete File
          </button>
          
          <!-- Download Button -->
          <a href="#" class="btn btn-sm btn-secondary" onclick="downloadFile()">
            <i class="bi bi-download"></i> Download
          </a>
        </div>
      </div>
      <div class="card-body">
        <% if (accounts.length === 0) { %>
          <div class="alert alert-info">
            This file is empty. Add some accounts to get started.
          </div>
        <% } else { %>
          <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-hover">
              <thead class="sticky-top bg-dark">
                <tr>
                  <th>#</th>
                  <th>Account</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% accounts.forEach((account, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td>
                      <div class="text-truncate" style="max-width: 400px;">
                        <%= account %>
                      </div>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-danger remove-account" data-index="<%= index %>">
                        <i class="bi bi-x-circle"></i> Remove
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Add Accounts</h5>
      </div>
      <div class="card-body">
        <form action="/stock/<%= folder %>/<%= file %>/add" method="POST">
          <div class="mb-3">
            <label for="accounts" class="form-label">Accounts (one per line)</label>
            <textarea class="form-control bg-secondary text-white" id="accounts" name="accounts" rows="10" placeholder="username:password"></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-plus-circle me-1"></i> Add Accounts
          </button>
        </form>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Upload File</h5>
      </div>
      <div class="card-body">
        <form action="/stock/<%= folder %>/<%= file %>/upload" method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="accountFile" class="form-label">Select File</label>
            <input class="form-control bg-secondary text-white" type="file" id="accountFile" name="accountFile">
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-upload me-1"></i> Upload File
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete File Modal -->
<div class="modal fade" id="deleteFileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Delete File</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong><%= file %></strong>?</p>
        <p class="text-danger">This action cannot be undone!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/stock/<%= folder %>/<%= file %>?_method=DELETE" method="POST">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('./partials/footer') %>

<script>
  // Download file as text
  function downloadFile() {
    const accounts = <%= JSON.stringify(accounts) %>;
    const content = accounts.join('\n');
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = '<%= file %>';
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
  }
  
  // Remove account functionality would be implemented in future version
  // This would require an API endpoint to handle individual account removal
</script>